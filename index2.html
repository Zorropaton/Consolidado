<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drogueria Online - Despacho 24 Horas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #3b82f6; /* Azul Principal */
            --color-primary-dark: #2563eb;
            --color-action: #14b8a6; /* Verde Menta (Acción) */
            --color-action-dark: #0d9488;
            --color-background: #f8fafc; /* Gris muy claro */
            --font-main: 'Lato', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--color-background);
        }
        .view-hidden { display: none; }
        .view-visible { display: block; }
        header { z-index: 20; }

        @keyframes cart-pop {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }
        .cart-icon-pop {
            animation: cart-pop 0.4s ease-in-out;
        }

        @keyframes scroll {
            from { transform: translateX(0); }
            to { transform: translateX(-100%); }
        }
        .offer-carousel-wrapper {
            position: relative;
            width: 100%;
            overflow: hidden;
            -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
            mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
        }
        .offer-carousel {
            display: flex;
            gap: 1rem;
            animation: scroll 80s linear infinite;
        }
        .offer-carousel-wrapper:hover .offer-carousel {
            animation-play-state: paused;
        }
        .offer-card {
            flex: 0 0 auto;
            width: 150px;
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            overflow: hidden;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }
        .offer-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px 0 rgb(0 0 0 / 0.1);
        }
        .offer-card img {
            width: 100%;
            height: 100px;
            object-fit: contain;
            background-color: #fff;
            padding: 0.25rem;
        }
        .offer-card-info { 
            padding: 0.5rem; 
            text-align: center; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            flex-grow: 1;
        }
        .offer-card-name {
            font-size: 0.75rem;
            font-weight: 700;
            color: #374151;
            line-height: 1.3;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            margin-bottom: 0.25rem;
        }
        .offer-card-price {
            font-size: 1rem;
            font-weight: 900;
            color: var(--color-primary-dark);
        }
        .offer-card-expiry {
            font-size: 0.7rem;
            font-weight: 400;
            color: #9ca3af; /* text-gray-400 */
            margin-top: 2px;
        }

        .why-us-card {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.05);
            border: 1px solid #e5e7eb;
        }
        .why-us-card .icon {
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
            color: var(--color-primary);
        }

        .footer-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1.5rem;
            text-align: center;
        }
        @media (min-width: 768px) {
            .footer-grid { grid-template-columns: repeat(3, 1fr); text-align: left; }
        }
        .footer-grid h3 { font-weight: 700; margin-bottom: 0.5rem; color: #d1d5db; }
        .footer-grid a { color: #9ca3af; transition: color 0.2s; }
        .footer-grid a:hover { color: white; }
        .footer-socials a { font-size: 1.25rem; }

        .pagination-btn {
            @apply inline-flex items-center justify-center px-3 py-1 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition ease-in-out duration-150;
        }
        .pagination-btn.active {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }
        .pagination-btn.active:hover {
            background-color: var(--color-primary-dark);
        }
        .pagination-btn:disabled {
            @apply opacity-50 cursor-not-allowed;
        }

        .table-container-no-scroll { width: 100%; overflow-x: auto; }
        table { width: 100%; table-layout: auto; border-collapse: collapse; }
        th, td {
            padding: 0.75rem 0.5rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        th {
            position: sticky;
            top: 0;
            background-color: #f3f4f6;
            z-index: 5;
            font-size: 0.75rem;
            font-weight: 700;
            color: #4b5563;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        td {
            font-size: 0.9rem;
            line-height: 1.4rem;
            color: #374151;
            vertical-align: middle;
        }
        .product-quantity-input {
            width: 100%;
            max-width: 65px;
            margin: 0 auto;
            text-align: center;
            padding: 0.25rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
        }
        
        @media (max-width: 768px) {
            thead { display: none; }
            tr { display: block; margin-bottom: 1rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 1rem; }
            td { display: flex; flex-direction: column; border: none; padding: 0.25rem 0; }
            td:before { content: attr(data-label); font-weight: bold; margin-bottom: 0.25rem; color: #6b7280; font-size: 0.75rem; }
        }

        @media (min-width: 769px) {
            th:nth-child(1), td:nth-child(1) { width: 8%; text-align: center;}
            th:nth-child(2), td:nth-child(2) { width: 30%; }
            th:nth-child(3), td:nth-child(3) { width: 15%; }
            th:nth-child(6), td:nth-child(6) { width: 10%; text-align: right; }
        }

        .add-to-cart-btn {
            background-color: var(--color-action);
            color: white;
            font-weight: bold;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1);
        }
        .add-to-cart-btn:hover {
            background-color: var(--color-action-dark);
            transform: scale(1.05);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

<header class="bg-white shadow-md sticky top-0">
    <nav class="container mx-auto px-4 py-2 flex justify-between items-center">
        <a href="#">
            <img src="https://raw.githubusercontent.com/Zorropaton/Consolidado/refs/heads/main/manufharm%2001%20fondo%20transparente.png" alt="Drogueria Manufharm Logo" class="h-14 w-auto">
        </a>
        <button id="cart-button" class="relative text-gray-700 hover:text-blue-600 transition duration-300">
            <i class="fas fa-shopping-cart fa-lg"></i>
            <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
        </button>
    </nav>
</header>

<main class="container mx-auto p-4">

    <section class="mb-10">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Ofertas Destacadas</h2>
        <div id="offer-carousel-wrapper" class="offer-carousel-wrapper">
            <div id="offer-carousel" class="offer-carousel">
                <!-- Tarjetas de oferta generadas por JS -->
            </div>
        </div>
    </section>

    <section id="product-view" class="view-visible">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Catálogo de Productos - Despacho en 24 Horas</h1>
        <div class="mb-6 relative">
            <input type="text" id="search-input" placeholder="Buscar remedio por descripción o EAN/Interno..." class="w-full p-3 pl-10 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
        </div>
        <p id="loading-message" class="text-center text-blue-600 my-4">Cargando productos...</p>
        <p id="error-message" class="text-center text-red-600 my-4 hidden"></p>

        <div class="bg-white shadow-md rounded-lg overflow-hidden table-container-no-scroll">
            <table class="divide-y divide-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th>Imagen</th>
                        <th>Descripción (Click para ver detalle)</th>
                        <th>Laboratorio</th>
                        <th>Código EAN/Ref.</th>
                        <th>Código Interno</th>
                        <th>Precio Neto</th>
                        <th>Fecha Vencimiento</th>
                        <th>Stock</th>
                        <th>Cantidad</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody id="product-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Filas de productos generadas por JS -->
                </tbody>
            </table>
        </div>
        <p id="no-results" class="text-center text-gray-500 mt-4 hidden">No se encontraron productos.</p>
        <div id="pagination-controls" class="flex justify-center items-center space-x-1 mt-6">
            <!-- Controles de paginación generados por JS -->
        </div>
    </section>

    <section id="product-detail-view" class="view-hidden">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Detalle del Producto</h1>
            <button id="back-to-products-detail" class="text-blue-600 hover:text-blue-800 transition duration-300">
                <i class="fas fa-arrow-left mr-2"></i>Volver a Productos
            </button>
        </div>
        <div class="bg-white shadow-md rounded-lg p-6 md:p-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 items-start">
                <div>
                    <img id="detail-img" src="https://placehold.co/400x400/e0e7ff/374151?text=Producto" alt="Imagen del Producto" class="w-full h-auto object-cover rounded-lg shadow-sm mb-4 md:mb-0" onerror="this.src='https://placehold.co/400x400/e0e7ff/374151?text=Error en Img'">
                </div>
                <div class="flex flex-col justify-between h-full">
                    <div>
                        <h2 id="detail-desc" class="text-2xl font-semibold text-gray-800 mb-2">Nombre del Producto</h2>
                        <p class="text-sm text-gray-500 mb-1">Código EAN/Ref.: <span id="detail-ean" class="font-medium text-gray-700">0000000000000</span></p>
                        <p class="text-sm text-gray-500 mb-4">Código Interno: <span id="detail-interno" class="font-medium text-gray-700">N/A</span></p>
                        <p class="text-sm text-gray-500 mb-4">Laboratorio: <span id="detail-laboratorio" class="font-medium text-gray-700">N/A</span></p>
                        <p class="text-3xl font-bold text-blue-600 mb-4" id="detail-price">$0</p>
                        <p class="text-gray-700 mb-4">
                            <span class="font-semibold">Descripción adicional:</span>
                            <span id="detail-extra-desc"> Aquí iría una descripción más detallada del producto si estuviera disponible.</span>
                        </p>
                        <p class="text-sm text-gray-500 mb-4">Fecha de Vencimiento: <span id="detail-vence" class="font-medium text-gray-700">DD/MM/AAAA</span></p>
                        <p class="text-sm text-gray-500 mb-4">Stock Disponible: <span id="detail-stock" class="font-medium text-gray-700">N/A</span></p>
                    </div>
                    <div class="flex items-center space-x-4 mt-4">
                        <label for="detail-quantity" class="block text-sm font-medium text-gray-700">Cantidad:</label>
                        <input type="number" id="detail-quantity" value="1" min="1" class="w-24 p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="detail-add-to-cart-btn" class="add-to-cart-btn" data-ean="">
                            <i class="fas fa-cart-plus mr-2"></i>Agregar al Carrito
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="cart-view" class="view-hidden">
        <!-- Contenido original de la vista del carrito -->
    </section>

    <section class="mt-12">
        <div class="why-us-card max-w-2xl mx-auto">
            <div class="icon"><i class="fas fa-truck-fast"></i></div>
            <h3 class="font-bold text-gray-800">Despacho Rápido y Climatizado</h3>
            <p class="text-sm text-gray-600">Según la norma, manteniendo la cadena de frío.</p>
        </div>
    </section>
</main>

<footer class="bg-gray-800 text-white mt-10 pt-10 pb-6">
    <div class="container mx-auto px-4">
        <div class="footer-grid mb-8">
            <div>
                <h3 class="uppercase">Drogueria Manufharm</h3>
                <p class="text-sm text-gray-400">Cuidando tu salud con productos de calidad y confianza.</p>
            </div>
            <div>
                <h3 class="uppercase">Enlaces Útiles</h3>
                <ul class="space-y-2 text-sm">
                    <li><a href="#" class="hover:underline">Quiénes Somos</a></li>
                    <li><a href="#" class="hover:underline">Políticas de Despacho</a></li>
                    <li><a href="#" class="hover:underline">Preguntas Frecuentes</a></li>
                </ul>
            </div>
            <div>
                <h3 class="uppercase">Contacto</h3>
                <ul class="space-y-2 text-sm text-gray-400">
                    <li><i class="fas fa-map-marker-alt fa-fw mr-2"></i>Av. Buzzeta 3558, Estación Central</li>
                    <li><i class="fas fa-phone fa-fw mr-2"></i>+56 9 6617 7413</li>
                    <li><i class="fas fa-envelope fa-fw mr-2"></i>contacto.manufharm@gmail.com</li>
                </ul>
            </div>
        </div>
        <div class="border-t border-gray-700 pt-6 text-center text-sm text-gray-400">
            <p>© 2025 Drogueria Manufharm. Todos los derechos reservados.</p>
        </div>
    </div>
</footer>

<script>
    const bannerProducts = [
        { name: "GLIBENCLAMIDA 5MG X60 COMP", price: 50, imageUrl: "https://www.farmaciasahumada.cl/dw/image/v2/BJVH_PRD/on/demandware.static/-/Sites-ahumada-master-catalog/default/dwc24c6761/images/products/84050/84050.jpg?sw=525&sh=525&sm=fit", ean: "7800007120410", vence: "ago-25" },
        { name: "METORENE COM 12,5MGX30 COM (megalabs)", price: 2000, imageUrl: "https://www.farmaciasahumada.cl/dw/image/v2/BJVH_PRD/on/demandware.static/-/Sites-ahumada-master-catalog/default/dwaa4990f8/images/products/93409/93409.jpg?sw=525&sh=525&sm=fit", ean: "7800059006922", vence: "sept-25" },
        { name: "NISTATINA OVULOS 100.000 UI X 12", price: 1000, imageUrl: "https://www.laboratoriochile.cl/wp-content/webp-express/webp-images/doc-root/wp-content/uploads/2019/03/Nistatina_100000UI_12O_HD.jpg.webp", ean: "7800007142573", vence: "sept-25" },
        { name: "AZITROMICINA 200MG-5ML SUSP 15ML (hospifarma)", price: 1100, imageUrl: "https://www.farmaciasahumada.cl/on/demandware.static/-/Sites-ahumada-master-catalog/default/dw16553406/images/products/89515/89515.jpg", ean: "7804640561388", vence: "oct-25" },
        { name: "LORATADINA JBE 5MG-5ML 90ML (mintlab)", price: 850, imageUrl: "https://www.farmaciasahumada.cl/on/demandware.static/-/Sites-ahumada-master-catalog/default/dwd8824c94/images/products/90385/90385.jpg", ean: "7800063130699", vence: "oct-25" },
        { name: "SERTRALINA 50MGX30 COMP (hetero)", price: 260, imageUrl: "https://assets.farmaciameki.cl/images/093195d0-d484-48fe-8e4b-3db450c3804d/large.jpeg?u=1749217278615", ean: "7800007670595", vence: "oct-25" },
        { name: "CETIRIZINA CLORHIDRATO 10MGX30 COMP (cureaspring)", price: 550, imageUrl: "https://www.ecofarmacias.cl/wp-content/uploads/2024/06/cetirizina-clorhidrato-10-mg-x-30.jpg", ean: "7804673040362", vence: "oct-25" },
        { name: "ASPIRINA FORTE 650MGX80 COMP (bayer)", price: 2441, imageUrl: "https://www.belgochilena.cl/wp-content/uploads/2023/05/aspirina-forte-650-mg-x-80-comp-bayer-860492_grande.jpg", ean: "7793640002543", vence: "nov-25" },
        { name: "BALSAMO ANALGESICO UNGUENTO 15 G.", price: 880, imageUrl: "https://www.ecofarmacias.cl/wp-content/uploads/2021/01/balsamo-analgesico-pasteur-unguento-15-gr.jpg", ean: "7800068010415", vence: "nov-25" },
        { name: "RIVOXA(B) 15MG 30 COMP", price: 31585, imageUrl: "https://static.salcobrandonline.cl/spree/products/128757/large_webp/580714_1.webp?1733411514", ean: "7800060163812", vence: "nov-25" },
        { name: "(DM) ALGODÓN HIDRÓFILO PRENSADO ROLLO 1KG X 1 UNID.", price: 2800, imageUrl: "https://afchilespa.cl/wp-content/uploads/2022/10/DMAP000003.png", ean: "7804666063644", vence: "dic-25" },
        { name: "CLORANFENICOL UNGÜENTO OFT 1% X3.5G.(hospifarma)", price: 934, imageUrl: "https://farmacia.araucomed.com/5717-large_default/cloranfenicol-1-unguento-oftalmico-35g-hospifarma.jpg", ean: "7804640560107", vence: "dic-25" },
        { name: "TESTOSTERONA 250MG-MLx1 AMP (ethon)", price: 5000, imageUrl: "https://farmacia.araucomed.com/11975-large_default/testosterona-solucion-inyectable-250mg-1ml-x-1-ampolla-ethon.jpg", ean: "7804633500042", vence: "dic-25" },
        { name: "VALAX 160MGX30COMP (saval)", price: 3667, imageUrl: "https://www.surfarma.cl/archivos/2020/11/30444_VALAX-160-MG-30-COM-1024x1024.jpg", ean: "7800060147102", vence: "dic-25" },
        { name: "ZOPICLONA 7,5MGX30 COM REC (ascend)", price: 590, imageUrl: "https://assets.farmaciameki.cl/images/c3321932-28b0-4fb9-8105-4863f90c95de/thumb.png", ean: "7804650886020", vence: "dic-25" },
        { name: "CLARIMIR F SOL OFT X15ml (andromaco)", price: 1900, imageUrl: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRc9ymEwyu0A6nql1PFhqvKKi_0-1hlSh-Hsg&s", ean: "7800018000961", vence: "dic-25" },
        { name: "ACUODE 50.000 UI SOL. ORAL CAJA X 2 SOBRES (COLECALCIFEROL)", price: 11750, imageUrl: "https://s3.us-east-2.amazonaws.com/basestack-publicbucketa6745c15-1ul2knuv6sta7/images/2cea5f0b-96e1-45ef-bace-1172c7e2834c/large.jpeg?u=1722007651771", ean: "7800026004791", vence: "ene-26" },
        { name: "CLARAGINE X16 COMP (prater)", price: 700, imageUrl: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTfV82p89cNgxzC9OyrogLBkdOGh4BtlYJGAQ&s", ean: "7804918402054", vence: "ene-26" },
        { name: "DOLORUB 5% CR 45G (maver)", price: 1800, imageUrl: "https://www.ecofarmacias.cl/wp-content/uploads/2019/07/Dolorub-45-g.jpg", ean: "7800004508594", vence: "ene-26" },
        { name: "ESPIRONOLACTONA 25 MGX20 COMP BE", price: 608, imageUrl: "https://www.farmaciasahumada.cl/on/demandware.static/-/Sites-ahumada-master-catalog/default/dwf22ad1d2/images/products/1483/1483.jpg", ean: "7800034507567", vence: "ene-26" },
        { name: "FORLIP 10 MG", price: 2570, imageUrl: "https://www.novasalud.cl/media/catalog/product/cache/1a10d735dfa619d2686c17030920c9f1/4/0/4004990.jpg", ean: "7804650882947", vence: "ene-26" },
        { name: "ROSUVASTATINA [ES] 10MGX30 COMP REC (sevenpharma)", price: 1500, imageUrl: "https://farmex.cl/cdn/shop/files/rosuvastatina-10-mg-x-30-comp-recubiertos-seven-pharma-261717_1024x1024.jpg?v=1722573243", ean: "8903726193372", vence: "ene-26" },
        { name: "TAPSIN ROJ-CAF X200 COMP (maver)", price: 5460, imageUrl: "https://assets.farmaciameki.cl/images/0e3ab861-4772-4aed-b376-d3e09eb2ec7a/large.jpeg?u=1722007631845", ean: "7800004000890", vence: "ene-26" }
    ];

    let allProducts = [], displayProducts = [], cart = [], currentPage = 1;
    const itemsPerPage = 10;
    
    const getEl = (id) => document.getElementById(id);
    const productTableBody = getEl('product-table-body'), searchInput = getEl('search-input'), cartButton = getEl('cart-button'), paginationControls = getEl('pagination-controls'), loadingMessage = getEl('loading-message'), errorMessage = getEl('error-message'), noResultsMessage = getEl('no-results'), offerCarousel = getEl('offer-carousel'), productView = getEl('product-view'), cartView = getEl('cart-view'), productDetailView = getEl('product-detail-view'), detailImg = getEl('detail-img'), detailDesc = getEl('detail-desc'), detailEan = getEl('detail-ean'), detailInterno = getEl('detail-interno'), detailLaboratorio = getEl('detail-laboratorio'), detailPrice = getEl('detail-price'), detailVence = getEl('detail-vence'), detailStock = getEl('detail-stock'), detailAddToCartBtn = getEl('detail-add-to-cart-btn'), detailQuantityInput = getEl('detail-quantity'), detailExtraDesc = getEl('detail-extra-desc');

    const formatCurrencyWithSymbol = (amount) => `$${Math.round(parseFloat(amount) || 0).toLocaleString('es-CL')}`;

    const renderOfferCarousel = () => {
        if (!offerCarousel) return;
        const duplicatedProducts = [...bannerProducts, ...bannerProducts];
        offerCarousel.innerHTML = duplicatedProducts.map(product => `
            <div class="offer-card" data-ean="${product.ean}">
                <img src="${product.imageUrl}" alt="${product.name}" onerror="this.src='https://placehold.co/150x100/e0e7ff/374151?text=Error'">
                <div class="offer-card-info">
                    <div class="offer-card-name">${product.name}</div>
                    <div>
                        <div class="offer-card-price">${formatCurrencyWithSymbol(product.price)}</div>
                        <div class="offer-card-expiry">Vence: ${product.vence}</div>
                    </div>
                </div>
            </div>
        `).join('');
        offerCarousel.querySelectorAll('.offer-card').forEach(card => card.addEventListener('click', (e) => showProductDetail({ currentTarget: card })));
    };

    const parseCSV = (csvText) => {
        const lines = csvText.trim().split(/\r\n|\n/);
        if (lines.length <= 1) return [];
        const headers = lines[0].split(';').map(h => h.trim().toUpperCase());
        return lines.slice(1).map(line => {
            const values = line.split(';');
            const productData = {};
            headers.forEach((header, index) => {
                productData[header] = values[index] ? values[index].trim() : '';
            });
            productData.NETO_NUMERICO = parseFloat(productData.NETO.replace(/[$.]/g, '').replace(',', '.')) || 0;
            productData.STOCK = parseInt(productData.SALDO) || 0;
            productData["EAN-VALOR"] = productData.BARRA || productData.PRODUCTO;
            return productData;
        }).filter(p => p.DESCPROD);
    };
    
    const fetchProducts = async () => {
        loadingMessage.classList.remove('hidden');
        try {
            const response = await fetch('https://raw.githubusercontent.com/Zorropaton/Consolidado/main/productos_pag.csv');
            if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
            const csvText = await response.text();
            allProducts = parseCSV(csvText);
            displayProducts = [...allProducts];
            renderProducts();
            renderPaginationControls();
        } catch (error) {
            errorMessage.textContent = `Error al cargar productos: ${error.message}.`;
            errorMessage.classList.remove('hidden');
        } finally {
            loadingMessage.classList.add('hidden');
        }
    };
    
    const renderProducts = () => {
        productTableBody.innerHTML = '';
        noResultsMessage.classList.toggle('hidden', displayProducts.length > 0 || !loadingMessage.classList.contains('hidden'));
        
        const startIndex = (currentPage - 1) * itemsPerPage;
        const productsToRender = displayProducts.slice(startIndex, startIndex + itemsPerPage);

        productsToRender.forEach(product => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            row.innerHTML = `
                <td data-label="Imagen"><img src="${product.IMAGEN || 'https://placehold.co/50x50'}" alt="${product["DESCPROD"]}" class="h-10 w-10 rounded-md object-cover mx-auto"></td>
                <td data-label="Descripción" class="product-description-cell cursor-pointer hover:text-blue-600" data-ean="${product["EAN-VALOR"]}"><div class="text-sm font-medium text-gray-900">${product["DESCPROD"]}</div><div class="text-xs text-gray-500">Vence: ${product.FECLOTE || 'N/A'}</div></td>
                <td data-label="Laboratorio" class="text-sm text-gray-500">${product.LABORATORIO || 'N/A'}</td>
                <td data-label="Código EAN/Ref." class="text-sm text-gray-500">${product["EAN-VALOR"]}</td>
                <td data-label="Código Interno" class="text-sm text-gray-500">${product.PRODUCTO || 'N/A'}</td>
                <td data-label="Precio Neto" class="text-sm text-gray-700 font-semibold text-right">${formatCurrencyWithSymbol(product.NETO_NUMERICO)}</td>
                <td data-label="Fecha Vencimiento" class="text-sm text-gray-500 text-center">${product.FECLOTE || 'N/A'}</td>
                <td data-label="Stock" class="text-sm text-gray-500 text-center">${product.STOCK}</td>
                <td data-label="Cantidad" class="text-center"><input type="number" value="1" min="1" class="product-quantity-input"></td>
                <td data-label="Acción" class="text-center"><button class="add-to-cart-btn" data-ean="${product["EAN-VALOR"]}"><i class="fas fa-cart-plus"></i></button></td>
            `;
            productTableBody.appendChild(row);
        });

        document.querySelectorAll('.add-to-cart-btn').forEach(b => b.addEventListener('click', handleAddToCart));
        document.querySelectorAll('.product-description-cell').forEach(c => c.addEventListener('click', showProductDetail));
    };

    const renderPaginationControls = () => {
        paginationControls.innerHTML = '';
        const totalPages = Math.ceil(displayProducts.length / itemsPerPage);
        if (totalPages <= 1) return;
        
        const createButton = (html, page, isDisabled = false, isActive = false) => {
            const button = document.createElement('button');
            button.innerHTML = html;
            button.className = `pagination-btn ${isActive ? 'active' : ''}`;
            button.disabled = isDisabled;
            button.onclick = () => changePage(page);
            return button;
        };

        paginationControls.appendChild(createButton(`<i class="fas fa-chevron-left"></i>`, currentPage - 1, currentPage === 1));
        
        const pages = [];
        if (totalPages <= 7) {
            for (let i = 1; i <= totalPages; i++) pages.push(i);
        } else {
            pages.push(1);
            if (currentPage > 3) pages.push('...');
            for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) pages.push(i);
            if (currentPage < totalPages - 2) pages.push('...');
            pages.push(totalPages);
        }

        pages.forEach(p => {
            if (p === '...') {
                const span = document.createElement('span');
                span.className = 'px-3 py-1 text-sm';
                span.textContent = '...';
                paginationControls.appendChild(span);
            } else {
                paginationControls.appendChild(createButton(p, p, false, p === currentPage));
            }
        });

        paginationControls.appendChild(createButton(`<i class="fas fa-chevron-right"></i>`, currentPage + 1, currentPage === totalPages));
    };

    const changePage = (page) => {
        currentPage = page;
        renderProducts();
        renderPaginationControls();
        getEl('product-view').scrollIntoView({ behavior: 'smooth', block: 'start' });
    };

    const filterProducts = () => {
        const searchTerm = searchInput.value.toLowerCase().trim();
        displayProducts = allProducts.filter(p => 
            (p.DESCPROD && p.DESCPROD.toLowerCase().includes(searchTerm)) ||
            (p["EAN-VALOR"] && String(p["EAN-VALOR"]).toLowerCase().includes(searchTerm))
        );
        currentPage = 1;
        renderProducts();
        renderPaginationControls();
    };

    const showView = (viewId) => {
        productView.classList.replace('view-visible', 'view-hidden');
        cartView.classList.replace('view-visible', 'view-hidden');
        productDetailView.classList.replace('view-visible', 'view-hidden');
        getEl(viewId).classList.replace('view-hidden', 'view-visible');
        window.scrollTo(0, 0);
    };
    
    const showProductDetail = (event) => {
        const ean = event.currentTarget.dataset.ean;
        const product = allProducts.find(p => String(p["EAN-VALOR"]) === ean);
        if (product) {
            detailImg.src = product.IMAGEN || `https://placehold.co/400x400/e0e7ff/374151?text=N/A`;
            detailDesc.textContent = product.DESCPROD;
            detailEan.textContent = product["EAN-VALOR"];
            detailInterno.textContent = product.PRODUCTO || 'N/A';
            detailLaboratorio.textContent = product.LABORATORIO || 'N/A';
            detailPrice.textContent = formatCurrencyWithSymbol(product.NETO_NUMERICO);
            detailVence.textContent = product.FECLOTE || 'N/A';
            detailStock.textContent = product.STOCK;
            detailQuantityInput.value = "1";
            detailAddToCartBtn.dataset.ean = String(product["EAN-VALOR"]);
            detailExtraDesc.textContent = `Válido hasta ${product.FECLOTE || 'N/A'}.`;
            showView('product-detail-view');
        } else {
            showToast("Producto no encontrado en el catálogo.", 'error');
        }
    };

    const showToast = (message, type = 'success') => {
        const toast = document.createElement('div');
        const colors = { success: 'bg-green-600', error: 'bg-red-600', warning: 'bg-yellow-500 text-black' };
        toast.className = `fixed bottom-5 right-5 ${colors[type]} text-white px-5 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 opacity-0 transform translate-y-4`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => { toast.style.opacity = '1'; toast.style.transform = 'translateY(0)'; }, 10);
        setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
    };

    const handleAddToCart = (e) => { 
        showToast("Producto agregado (lógica de carrito pendiente)", "success");
        cartButton.classList.add('cart-icon-pop');
        setTimeout(() => cartButton.classList.remove('cart-icon-pop'), 400);
    };

    document.addEventListener('DOMContentLoaded', () => {
        renderOfferCarousel();
        fetchProducts();
        searchInput.addEventListener('input', filterProducts);
        getEl('back-to-products-detail').addEventListener('click', () => showView('product-view'));
        getEl('back-to-products-cart').addEventListener('click', () => showView('product-view'));
    });
</script>
</body>
</html>
